<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Five Queens Jewelry â€” Admin Dashboard</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<h1>Admin Dashboard</h1>

<h2>Orders</h2>
<table id="orders-table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Customer</th>
      <th>Email</th>
      <th>Phone</th>
      <th>Address</th>
      <th>Items</th>
      <th>Total</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Monthly Best Seller</h2>
<div id="best-seller"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script src="supabase.js"></script>
<script>

// Load orders
async function loadOrders() {
  const { data: orders, error } = await supabase.from('orders').select('*').order('created_at',{ascending:false});
  if(error){ console.error(error); return; }

  const tbody = document.querySelector('#orders-table tbody');
  tbody.innerHTML = '';

  orders.forEach(order => {
    let itemsHtml = '';
    order.items.forEach(item=>{
      itemsHtml += `<div style="display:flex;align-items:center;margin-bottom:5px;">
        <img src="${item.image_url}" width="50" height="50" style="margin-right:5px;border-radius:6px;">
        <span>${item.name} ($${item.price})</span>
      </div>`;
    });

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${order.id}</td>
      <td>${order.name}</td>
      <td>${order.email}</td>
      <td>${order.phone}</td>
      <td>${order.address}</td>
      <td>${itemsHtml}</td>
      <td>$${order.total}</td>
      <td>${order.status}</td>
      <td>
        <button class="paid">Mark Paid</button>
        <button class="delivered">Mark Delivered</button>
      </td>
    `;

    tr.querySelector('.paid').addEventListener('click',()=>updateStatus(order.id,'paid'));
    tr.querySelector('.delivered').addEventListener('click',()=>updateStatus(order.id,'delivered'));

    tbody.appendChild(tr);
  });
}

// Update status via Edge Function
async function updateStatus(orderId,status){
  try {
    const response = await fetch('https://<project-ref>.functions.supabase.co/update-order-status',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({orderId,status})
    });
    const result = await response.json();
    if(result.error){ alert(result.error); return; }
    loadOrders();
  } catch(err){ console.error(err); alert("Error updating order"); }
}

// Calculate monthly best seller
async function loadBestSeller() {
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate()-30);
  const { data: orders, error } = await supabase
    .from('orders')
    .select('items')
    .gte('created_at', thirtyDaysAgo.toISOString());
  if(error){ console.error(error); return; }

  const productCount = {};
  orders.forEach(order=>{
    order.items.forEach(item=>{
      productCount[item.name] = (productCount[item.name] || 0) + 1;
    });
  });

  let bestSeller = null, max = 0;
  for(const [name,count] of Object.entries(productCount)){
    if(count>max){ max=count; bestSeller=name; }
  }

  document.getElementById('best-seller').textContent = bestSeller ? `Best Seller This Month: ${bestSeller} (${max} sold)` : "No sales this month.";
}

loadOrders();
loadBestSeller();
</script>
</body>
</html>
